---
layout: post
title: Rancher Virtualization
tags: [Virtualization]
color: rgb(224, 1, 152)
feature-img: "assets/img/post-cover/36-cover.png"
thumbnail: "assets/img/post-cover/36-cover.png"
author: QubitPi
excerpt_separator: <!--more-->
---

<!--more-->

* TOC
{:toc}

## Overview

Rancher is a container management platform built for organizations that deploy containers in production.

Rancher users have the choice of creating Kubernetes clusters with Rancher Kubernetes Engine (RKE) or cloud Kubernetes
services, such as GKE, AKS, and EKS.

### Meet IT Requirements

Rancher supports centralized authentication, access control, and monitoring for all Kubernetes clusters under its
control. For example, you can:

* Use your Active Directory credentials to access Kubernetes clusters hosted by cloud vendors, such as GKE.
* Setup and enforce access control and security policies across all users, groups, projects, clusters, and clouds.
* View the health and capacity of your Kubernetes clusters from a single-pane-of-glass.

### Empower DevOps Teams

Rancher provides an intuitive user interface for DevOps engineers to manage their application workload. Rancher is
certified with a wide selection of cloud native ecosystem products, including, for example, security tools, monitoring
systems, container registries, and storage and networking drivers.

The following figure illustrates the role Rancher plays in IT and DevOps organizations. _Each team deploys their
applications on the public or private clouds they choose. IT administrators gain visibility and enforce policies across
all users, clusters, and clouds.

![rancher-platform.png not loaded property]({{ "/assets/img/rancher-platform.png" | relative_url}})

### Rancher API Server

The Rancher API server is built on top of an embedded Kubernetes API server and an [etcd database](https://etcd.io/). It
implements the following functionalities:

#### Authorization and Role-Based Access Control

* **User management**: The Rancher API server
  [manages user identities](https://rancher.com/docs/rancher/v2.5/en/admin-settings/authentication/) that correspond to
  external authentication providers like Active Directory or GitHub, in addition to local users.
* **Authorization**: The Rancher API server manages
  [access control](https://rancher.com/docs/rancher/v2.5/en/admin-settings/rbac/) and
  [security](https://rancher.com/docs/rancher/v2.5/en/admin-settings/pod-security-policies/) policies.
  
#### Working with Kubernetes

* **Provisioning Kubernetes clusters**: The Rancher API server can
  [provision Kubernetes](https://rancher.com/docs/rancher/v2.5/en/cluster-provisioning/) on existing nodes, or perform
  [Kubernetes upgrades](https://rancher.com/docs/rancher/v2.5/en/cluster-admin/upgrading-kubernetes).
* **Catalog management**: Rancher provides the ability to use a
  [catalog of Helm charts](https://rancher.com/docs/rancher/v2.5/en/catalog/) that make it easy to repeatedly deploy
  applications.
* **Managing projects**: **A project is a group of multiple namespaces and access control policies within a cluster**. A
  project is a Rancher concept, not a Kubernetes concept, which allows you to manage multiple namespaces as a group and
  perform Kubernetes operations in them. The Rancher UI provides features for
  [project administration](https://rancher.com/docs/rancher/v2.5/en/project-admin/) and
  [for managing applications within projects](https://rancher.com/docs/rancher/v2.5/en/k8s-in-rancher/).
* **Pipelines**: Setting up a [pipeline](https://rancher.com/docs/rancher/v2.5/en/project-admin/pipelines/) can help
  developers deliver new software as quickly and efficiently as possible. Within Rancher, you can configure pipelines
  for each of your Rancher projects.
* **Istio**: Our integration with Istio is designed so that a Rancher operator, such as an administrator or cluster
  owner, can deliver Istio to developers. Then developers can use Istio to enforce security policies, troubleshoot
  problems, or manage traffic for green/blue deployments, canary deployments, or A/B testing.

#### Working with Cloud Infrastructure

* **Tracking nodes**: The Rancher API server tracks identities of all the nodes in all clusters.
* **Setting up infrastructure**: When configured to use a cloud provider, Rancher can dynamically provision new nodes
  and persistent storage in the cloud.

#### Cluster Visibility

* **Logging**: Rancher can integrate with a variety of popular logging services and tools that exist outside of your
  Kubernetes clusters.
* **Monitoring**: Using Rancher, you can monitor the state and processes of your cluster nodes, Kubernetes components,
  and software deployments through integration with Prometheus, a leading open-source monitoring solution.
* **Alerting**: To keep your clusters and applications healthy and driving your organizational productivity forward, you
  need to stay informed of events occurring in your clusters and projects, both planned and unplanned.

## Architecture

The figure depicts a Rancher Server installation that manages two downstream Kubernetes clusters: one created by
[RKE](https://rancher.com/docs/rancher/v2.5/en/cluster-provisioning/rke-clusters/) and  another created by
[Amazon EKS (Elastic Kubernetes Service)](https://rancher.com/docs/rancher/v2.5/en/cluster-provisioning/hosted-kubernetes-clusters/).

![rancher-architecture-rancher-api-server.svg not loaded property]({{ "/assets/img/rancher-architecture-rancher-api-server.svg" | relative_url}})

### Communicating with Downstream User Clusters

The below diagram shows how the cluster controllers, cluster agents, and node agents allow Rancher to control downstream
clusters.

![rancher-architecture-cluster-controller.svg not loaded property]({{ "/assets/img/rancher-architecture-cluster-controller.svg" | relative_url}})

#### The Authentication Proxy

In this diagram, a user named Bob wants to see all pods running on a downstream user cluster called User Cluster 1.
From within Rancher, he can run a `kubectl` command to see the pods. Bob is authenticated through Rancher's
authentication proxy.

The authentication proxy forwards all Kubernetes API calls to downstream clusters. It integrates with authentication
services like local authentication, Active Directory, and GitHub. On every Kubernetes API call, the authentication proxy
authenticates the caller and sets the proper Kubernetes impersonation headers before forwarding the call to Kubernetes
masters.

Rancher communicates with Kubernetes clusters using a
[service account](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/), which provides
an identity for processes that run in a pod.

#### Cluster Controllers and Cluster Agent

Each downstream user cluster has a cluster agent, which opens a tunnel to the corresponding cluster controller within
the Rancher server.

There is one cluster controller and one cluster agent for each downstream cluster. Each cluster controller:

* Watches for resource changes in the downstream cluster
* Brings the current state of the downstream cluster to the desired state
* Configures access control policies to clusters and projects
* Provisions clusters by calling the required Docker machine drivers and Kubernetes engines, such as RKE and GKE

By default, to enable Rancher to communicate with a downstream cluster, the cluster controller connects to the cluster
agent. If the cluster agent is not available, the cluster controller can connect to a [node agent](#node-agents)
instead.

#### Node Agents

If the cluster agent (also called `cattle-cluster-agent`) is not available, one of the node agents creates a tunnel to
the cluster controller to communicate with Rancher.

The `cattle-node-agent` is deployed using a
[DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/) resource to make sure it runs on every
node in a Rancher-launched Kubernetes cluster. It is used to interact with the nodes when performing cluster operations.
Examples of cluster operations include upgrading the Kubernetes version and creating or restoring etcd snapshots.

#### Authorized Cluster Endpoint

An authorized cluster endpoint allows users to connect to the Kubernetes API server of a downstream cluster without
having to route their requests through the Rancher authentication proxy.

> The authorized cluster endpoint only works on Rancher-launched Kubernetes clusters. In other words, it only works in
> clusters where Rancher [used RKE](https://rancher.com/docs/rancher/v2.5/en/cluster-provisioning/rke-clusters) to
> provision the cluster. It is not available for registered clusters, or for clusters in a hosted Kubernetes provider,
> such as Amazon EKS.

There are two main reasons why a user might need the authorized cluster endpoint:

1. To access a downstream user cluster while Rancher is down
2. To reduce latency in situations where the Rancher server and downstream cluster are separated by a long distance

## Pipelines

Rancher pipeline is very similar to [Yahoo's Screwdriver](https://screwdriver.cd/), which runs based on a YAML config
file, which contains all deployment specs, in git project and the file gets pushed to Jenkins to be executed.

Rancher's pipeline provides a simple CI/CD experience. Use it to **automatically**

* checkout code,
* run builds or scripts, 
* publish Docker images, and
* deploy the updated software to users

Setting up a pipeline can help developers deliver new software as quickly and efficiently as possible. Using Rancher,
you can integrate with a GitHub repository to setup a continuous integration (CI) pipeline.

After configuring Rancher and GitHub, you can deploy containers running Jenkins to automate a pipeline execution:

* Build your application from code to image.
* Validate your builds.
* Deploy your build images to your cluster.
* Run unit tests.
* Run regression tests.

### Concepts

* **Pipeline**: A _pipeline_ is a software delivery process that is broken into different stages and steps. Setting up a
  pipeline can help developers deliver new software as quickly and efficiently as possible. Within Rancher, you can
  configure pipelines for each of your Rancher projects. **A pipeline is based on a specific repository**. It defines
  the process to build, test, and deploy your code. Rancher uses the
  [pipeline as code](https://www.jenkins.io/doc/book/pipeline-as-code/) model. **Pipeline configuration is represented
  as a pipeline file in the source code repository**, using the file name `.rancher-pipeline.yml` or
  `.rancher-pipeline.yaml`.
* **Stages**: A pipeline stage consists of multiple steps. Stages are executed in the order defined in the pipeline
  file. The steps in a stage are executed concurrently. A stage starts when all steps in the former stage finish without
  failure.
* **Steps**: A pipeline step is executed inside a specified stage. A step fails if it exits with a code other than 0. If
  a step exits with this failure code, the entire pipeline fails and terminates.
* **Workspace**: The workspace is the working directory shared by all pipeline steps. In the beginning of a pipeline,
  source code is checked out to the workspace. The command for every step bootstraps in the workspace. During a pipeline
  execution, the artifacts from a previous step will be available in future steps. The working directory is an ephemeral
  volume and will be cleaned out with the executor pod when a pipeline execution is finished.

Typically, pipeline stages include:

1. **Build**: Each time code is checked into your repository, the pipeline automatically clones the repo and builds a
   new iteration of your software. Throughout this process, the software is typically reviewed by automated tests.
2. **Publish**: After the build is completed, either a Docker image is built and published to a Docker registry
3. **Deploy**: After the artifacts are published, you would release your application so users could start using the
   updated product.

### How Pipelines Work

After enabling the ability to use pipelines in a project, you can configure multiple pipelines in each project. Each
pipeline is unique and can be configured independently.

A pipeline is configured off of a group of files that are checked into source code repositories. Users can configure
their pipelines either through the Rancher UI or by adding a `.rancher-pipeline.yml` into the repository.

Before pipelines can be configured, you will need to configure authentication to your version control provider, e.g.
GitHub, GitLab, Bitbucket. If you haven't configured a version control provider, you can always use
[Rancher's example repositories](#example-repositories) to view some common pipeline deployments.

When you configure a pipeline in one of your projects, a namespace specifically for the pipeline is automatically
created. The following components are deployed to it:

1. **Jenkins** - The pipeline's build engine. Because project users do not directly interact with Jenkins, it's managed
   and locked.
   
   > Note that there is no option to use existing Jenkins deployments as the pipeline engine.

2. **Docker Registry** - Out-of-the-box, the default target for your build-publish step is an internal Docker Registry.
   However, _you can make configurations to push to a remote registry instead_. The internal Docker Registry is only
   accessible from cluster nodes and cannot be directly accessed by users. Images are not persisted beyond the lifetime
   of the pipeline and should only be used in pipeline runs. If you need to access your images outside of pipeline runs,
   please push to an external registry.
3. **Minio** - Minio storage is used to store the logs for pipeline executions.

> The managed Jenkins instance works statelessly, so don't worry about its data persistency. The Docker Registry and
> Minio instances use ephemeral volumes by default, which is fine for most use cases. If you want to make sure pipeline
> logs survive node failures, you can
> [configure persistent volumes for them](https://rancher.com/docs/rancher/v2.5/en/pipelines/storage/)